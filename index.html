<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Desktop Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light">
  <style>
    :root { --topbar-h: 38px; --pad: 8px; --max-w: 1920px; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font: 14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans";
      background: #f6f7f9; color: #111; overflow: hidden;
    }

    .topbar {
      position: fixed; inset: 0 0 auto 0; height: var(--topbar-h);
      padding: 4px 4px;
      background: #eef0f3;
      border-bottom: 1px solid #d6d9de; z-index: 10;
      display: grid; grid-auto-flow: column; align-items: center; gap: 6px;
    }
    .spacer { height: var(--topbar-h); }

    button, label { font: inherit; }
    button {
      height: 28px; padding: 0 10px;
      border: 1px solid #c9ced6; background: #fff; color:#111;
      border-radius: 8px; cursor: pointer;
      display: grid; place-items: center; white-space: nowrap;
    }
    button[disabled] { background: #eee; color: #999; border-color: #ddd; cursor: not-allowed; }

    .btn-primary { background: #2563eb; border-color: #1d4ed8; color: #fff; }
    .btn-primary:hover { filter: brightness(0.97); }

    #run.running { background: #3b82f6; color: #fff; border-color: #2563eb; cursor: progress; }
    #run.live    { background: #16a34a; color: #fff; border-color: #15803d; }
    #run.error   { background: #dc2626; color: #fff; border-color: #b91c1c; }

    .chk { display: grid; grid-auto-flow: column; align-items: center; gap: 6px; white-space: nowrap; }
    .chk input { transform: translateY(1px); }

    .grow { width: 1px; margin-left: auto; }

    .wrap { height: calc(100% - var(--topbar-h)); display: grid; grid-template-rows: auto 1fr; }
    .editor-wrap { padding: var(--pad); }
    .editor-wrap.collapsed { display: none; }

    textarea {
      width: 100%; height: 26vh; resize: vertical; padding: 10px;
      border: 1px solid #d6d9de; border-radius: 8px; background: #fff;
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      tab-size: 2; white-space: pre; overscroll-behavior: contain;
    }

    .stage { padding: 0 var(--pad) var(--pad); width: 100%; height: 100%; overflow: auto; display: grid; }
    .desk {
      width: 100%; max-width: var(--max-w); margin: 0 auto;
      background: #fff; border: 1px solid #ccd2da; border-radius: 8px; overflow: hidden;
      position: relative; box-shadow: 0 1px 3px rgba(0,0,0,.08), 0 8px 30px rgba(0,0,0,.06);
      height: 480px;
    }
    .desk > iframe { width: 100%; height: 100%; border: 0; display: block; background: #fff; }

    .toast {
      position: fixed; top: calc(var(--topbar-h) + 8px); left: 50%; transform: translateX(-50%);
      background: rgba(33, 37, 41, 0.92); color: #fff; padding: 6px 10px;
      border-radius: 8px; font-size: 12px; z-index: 20; opacity: 0; pointer-events: none;
      transition: opacity .15s ease;
    }
    .toast.show { opacity: 1; }

    #toggleEditorIcon { width: 28px; padding: 0; font-size: 16px; line-height: 1; }

    @media (max-width: 420px) {
      .topbar { gap: 4px; }
      button { padding: 0 8px; }
      .chk { gap: 4px; }
    }
  </style>
</head>
<body>
  <div class="topbar" id="topbar">
    <button id="toggleEditorIcon" title="–°–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä">üîΩ</button>
    <button id="paste">–í—Å—Ç–∞–≤–∏—Ç—å</button>
    <button id="run" disabled>–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
    <button id="clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <label class="chk" title="–£–±—Ä–∞—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ –∏ –ø–æ—Å–ª–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã">
      <input type="checkbox" id="sanitize" checked> –æ—á–∏—Å—Ç–∏—Ç—å –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç
    </label>
    <button id="toggleEditor" class="btn-primary">–°–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
    <div class="grow"></div>
    <button id="export">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å HTML</button>
  </div>
  <div class="spacer"></div>

  <div class="wrap">
    <div class="editor-wrap" id="editorWrap">
      <textarea id="code" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ HTML/JS/CSS. –ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º ‚Äî –æ—á–∏—Å—Ç–∫–∞ —É–¥–∞–ª–∏—Ç –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç –¥–æ/–ø–æ—Å–ª–µ HTML."></textarea>
    </div>

    <div class="stage">
      <div class="desk" id="desk">
        <iframe id="view"
          sandbox="allow-scripts allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-downloads allow-same-origin">
        </iframe>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
  (function () {
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

    function init() {
      const codeEl = document.getElementById('code');
      const pasteBtn = document.getElementById('paste');
      const runBtn = document.getElementById('run');
      const clearBtn = document.getElementById('clear');
      const exportBtn = document.getElementById('export');
      const sanitizeEl = document.getElementById('sanitize');
      const toggleEditorBtn = document.getElementById('toggleEditor');
      const toggleEditorIcon = document.getElementById('toggleEditorIcon');
      const editorWrap = document.getElementById('editorWrap');
      const desk = document.getElementById('desk');
      const toast = document.getElementById('toast');
      let iframe = document.getElementById('view');

      let timer;

      function showToast(text) {
        toast.textContent = text;
        toast.classList.add('show');
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => toast.classList.remove('show'), 900);
      }

      function layout() {
        const topbarH = document.getElementById('topbar').offsetHeight;
        const editorH = editorWrap.offsetParent ? editorWrap.offsetHeight : 0;
        const avail = window.innerHeight - topbarH - editorH - 8;
        desk.style.height = Math.max(240, avail) + 'px';
      }
      window.addEventListener('resize', layout);

      function updateRunState() {
        runBtn.disabled = !codeEl.value.trim();
      }

      function markRunning() {
        runBtn.classList.add('running');
        runBtn.textContent = '–ó–∞–ø—É—Å–∫...';
        runBtn.disabled = true;
      }
      function markLive() {
        runBtn.classList.remove('running', 'error');
        runBtn.classList.add('live');
        runBtn.textContent = '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å';
        runBtn.disabled = false;
      }
      function markError() {
        runBtn.classList.remove('running', 'live');
        runBtn.classList.add('error');
        runBtn.textContent = '–û—à–∏–±–∫–∞';
        runBtn.disabled = false;
      }

      function isEditorVisible() {
        return !editorWrap.classList.contains('collapsed');
      }
      function setEditorState(show) {
        editorWrap.classList.toggle('collapsed', !show);
        toggleEditorBtn.textContent = show ? '–°–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä' : '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä';
        toggleEditorIcon.textContent = show ? 'üîΩ' : 'üîº';
        toggleEditorIcon.title = show ? '–°–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä' : '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä';
        layout();
      }

      codeEl.addEventListener('input', updateRunState);
      toggleEditorBtn.addEventListener('click', () => setEditorState(!isEditorVisible()));
      toggleEditorIcon.addEventListener('click', () => setEditorState(!isEditorVisible()));

      pasteBtn.addEventListener('click', async () => {
        let inserted = null;
        try {
          if (navigator.clipboard?.readText) inserted = await navigator.clipboard.readText();
        } catch {}
        if (!inserted) inserted = prompt('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:') || '';
        const cleaned = sanitizeEl.checked ? extractHtml(inserted) : stripBOM(inserted).trim();
        codeEl.value = cleaned;
        updateRunState();
        showToast('–í—Å—Ç–∞–≤–ª–µ–Ω–æ');
        setEditorState(false);
        const doc = wrapDocument(cleaned);
        executeCode(doc);
      });

      clearBtn.addEventListener('click', () => {
        codeEl.value = '';
        updateRunState();
        resetIframe();
        showToast('–û—á–∏—â–µ–Ω–æ');
        setEditorState(true);
      });

      runBtn.addEventListener('click', () => {
        if (runBtn.disabled) return;
        const raw = codeEl.value;
        const cleaned = sanitizeEl.checked ? extractHtml(raw) : stripBOM(raw).trim();
        if (isEditorVisible()) setEditorState(false);
        const doc = wrapDocument(cleaned);
        executeCode(doc);
      });

      exportBtn.addEventListener('click', () => {
        const raw = codeEl.value;
        if (!raw.trim()) { showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); return; }
        const cleaned = sanitizeEl.checked ? extractHtml(raw) : stripBOM(raw).trim();
        const doc = wrapDocument(cleaned);
        downloadHtml(doc);
      });

      function executeCode(doc) {
        markRunning();
        resetIframe();
        const fresh = document.createElement('iframe');
        fresh.id = 'view';
        fresh.setAttribute('sandbox',
          'allow-scripts allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-downloads allow-same-origin');
        fresh.srcdoc = doc;
        desk.replaceChild(fresh, iframe);
        iframe = fresh;

        clearTimeout(timer);
        timer = setTimeout(() => markError(), 5000);
        iframe.onload = () => { clearTimeout(timer); markLive(); showToast('–ó–∞–ø—É—â–µ–Ω–æ'); };
        iframe.onerror = () => { clearTimeout(timer); markError(); };
      }

      function resetIframe() {
        const blank = document.createElement('iframe');
        blank.id = 'view';
        blank.setAttribute('sandbox',
          'allow-scripts allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-downloads allow-same-origin');
        blank.srcdoc = '<!doctype html><html><head><meta charset="utf-8"></head><body></body></html>';
        desk.replaceChild(blank, iframe);
        iframe = blank;
      }

      // –£–¥–∞–ª–µ–Ω–∏–µ BOM/ZWSP –≤ –Ω–∞—á–∞–ª–µ
      function stripBOM(t) {
        return (t || '').replace(/^\uFEFF/, '').replace(/^\u200B+/, '');
      }

      // –ê–∫–∫—É—Ä–∞—Ç–Ω–∞—è –≤—ã—Ä–µ–∑–∫–∞ HTML –∏–∑ ¬´—Å–æ–æ–±—â–µ–Ω–∏—è —Ü–µ–ª–∏–∫–æ–º¬ª
      function extractHtml(text) {
        let t = stripBOM(text || '');
        const fence = /```(?:html?|HTML?)?\s*([\s\S]*?)```/;
        const mFence = t.match(fence);
        if (mFence) t = mFence[1];

        const low = t.toLowerCase();
        const iDoctype = low.indexOf('<!doctype');
        const iHtml = low.indexOf('<html');
        let start = -1;
        if (iDoctype >= 0 && iHtml >= 0) start = Math.min(iDoctype, iHtml);
        else start = (iDoctype >= 0) ? iDoctype : iHtml;
        if (start >= 0) {
          t = t.slice(start);
          const endTag = t.toLowerCase().lastIndexOf('</html>');
          if (endTag >= 0) t = t.slice(0, endTag + 7);
          return t.trim();
        }
        return t.trim();
      }

      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º <meta charset> –∏ viewport –≤ <head>
      function wrapDocument(src) {
        let s = stripBOM(src || '');
        const hasHtml = /<\s*html[\s>]/i.test(s);
        const hasHead = /<\s*head[\s>]/i.test(s);
        const hasCharset = /<meta\s+charset=["']?utf-8["']?\s*>/i.test(s);
        const hasViewport = /<meta[^>]+name=["']viewport["'][^>]*>/i.test(s);
        const charset = `<meta charset="utf-8">`;
        const viewport = `<meta name="viewport" content="width=device-width, initial-scale=1">`;

        if (hasHtml) {
          if (hasHead) {
            // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–µ—Ç–∞ –≤ –Ω–∞—á–∞–ª–æ <head>
            s = s.replace(/<\s*head(\s[^>]*)?>/i, (m) => {
              let inject = '';
              if (!hasCharset) inject += charset;
              if (!hasViewport) inject += viewport;
              return m + inject;
            });
            return s;
          }
          // –ï—Å—Ç—å <html>, –Ω–æ –Ω–µ—Ç <head>
          return s.replace(/<\s*html([^>]*)>/i, (m, attrs) =>
            `<html${attrs}><head>${charset}${viewport}</head>`
          );
        }
        // –§—Ä–∞–≥–º–µ–Ω—Ç ‚Äî –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
        return `<!doctype html><html><head>${charset}${viewport}</head><body>${s}</body></html>`;
      }

      function downloadHtml(doc) {
        const blob = new Blob([doc], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'page.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 0);
        showToast('HTML —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      }

      updateRunState();
      layout();
      setEditorState(true);
    }
  })();
  </script>
</body>
</html>
